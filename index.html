<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>切手カウンター（複合額面・空白スタート）</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#105FCA" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    :root { --radius: 12px; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif;
      margin: 14px;
    }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .hint { color: #666; font-size: 12px; margin-bottom: 10px; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 8px 0; }
    button { padding: 10px 12px; border-radius: var(--radius); border: 1px solid #ccc; cursor: pointer; background: #fff; }
    .primary { background: #111; color: #fff; border-color: #111; }

    .sectionTitle { font-size: 13px; color: #666; margin: 8px 0; }

    .chipswrap { display:flex; gap:8px; overflow-x:auto; padding: 4px 0; }
    .chip { display:flex; gap:8px; align-items:center; padding:7px 10px; border:1px solid #ccc; background:#fff; border-radius:9999px; white-space:nowrap; user-select:none; }
    .chip:active { background:#f0f0f0; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
    th { text-align:left; font-weight: 600; color: #333; }
    .right { text-align:right; font-variant-numeric: tabular-nums; }

    /* 入力の統一サイズ */
    .amount-wrap { display:flex; align-items:center; gap:8px; }
    .input--box {
      height: 44px;
      min-width: 128px;
      padding: 0 12px;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 18px;
      width: 100%;
    }
    input[type="number"].input--box::-webkit-outer-spin-button,
    input[type="number"].input--box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"].input--box { -moz-appearance:textfield; }

    .plus-btn {
      width: 36px; height: 36px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #ccc; border-radius:12px; cursor:pointer;
      font-size:20px; line-height:1; user-select:none; background:#fff;
    }

    .summary { margin-top: 14px; padding: 12px; border: 1px solid #eee; border-radius: var(--radius); background: #fafafa; }
    .summary h2 { font-size: 14px; margin: 0 0 8px; }
    .totalbar { position: sticky; bottom: 0; background: rgba(255,255,255,0.96); backdrop-filter: blur(6px); padding: 8px 10px; border-top: 1px solid #eee; text-align: right; font-variant-numeric: tabular-nums; }

    @media (max-width: 480px){
      .input--box { min-width: 116px; font-size: 17px; }
      .plus-btn { width: 34px; height: 34px; font-size: 19px; }
    }
  </style>
</head>
<body>
  <h1>切手カウンター（複合額面・空白スタート）</h1>
  <div class="hint">
    額面は「20」だけでなく <b>20+100</b> のように＋で合算できます。<br>
    枚数（シート内）が空白/0 の時は <b>額面×シート数or枚数</b> で計算。下に明細テキストを自動表示します。
  </div>

  <div class="toolbar">
    <button id="addRow">行を追加</button>
    <button id="clearAll">全てクリア</button>
    <button id="shareBtn" class="primary">結果を共有/コピー</button>
  </div>

  <div class="sectionTitle">よく使う額面（編集可）</div>
  <div class="chipswrap">
    <div class="chips" id="chips"></div>
    <button id="editPresets">編集</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>額面（円, 例: 20 または 20+100）</th>
        <th>枚数（シート内）</th>
        <th>シート数 or 枚数</th>
        <th class="right">小計</th>
        <th>行</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="summary">
    <h2>明細</h2>
    <div id="detail">(ここに計算式が表示されます)</div>
  </div>

  <div class="totalbar">合計 <span id="grand">0</span> 円</div>

  <script>
    // ---- 永続化キー
    const LS_PRESETS = 'stamp_presets_v1';
    const LS_ROWS    = 'stamp_rows_v1';

    // ---- プリセット（既定値）
    function getPresets(){
      try{
        const saved = localStorage.getItem(LS_PRESETS);
        const a = saved ? JSON.parse(saved) : null;
        if (Array.isArray(a)) return a;
      }catch{}
      return [1,2,5,10,20,30,50];
    }
    function setPresets(arr){
      localStorage.setItem(LS_PRESETS, JSON.stringify(arr));
    }

    // ---- 行の永続化
    function saveRows(){
      const data = [];
      document.querySelectorAll('#rows tr').forEach(tr=>{
        data.push({
          amount: tr.querySelector('.amount')?.value ?? '',
          per:     tr.querySelector('.per')?.value ?? '',
          sheets:  tr.querySelector('.sheets')?.value ?? ''
        });
      });
      localStorage.setItem(LS_ROWS, JSON.stringify(data));
    }
    function loadRows(){
      try{
        const t = localStorage.getItem(LS_ROWS);
        const a = t ? JSON.parse(t) : [];
        return Array.isArray(a) ? a : [];
      }catch{ return []; }
    }

    // ---- プリセット描画
    function renderChips(){
      const wrap = document.getElementById('chips');
      wrap.innerHTML = '';
      getPresets().forEach(v=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = `${v}円`;
        b.addEventListener('click', ()=> onPresetClick(v));
        wrap.appendChild(b);
      });
    }

    // プリセットクリック: 新しい行で額面セット
    function onPresetClick(v){
      const tr = addRow(String(v), '', '');
      tr.querySelector('.amount')?.focus();
      recalc();
    }

    // ---- 行追加
    function addRow(amountText='', perSheetText='', sheetOrCount=''){
      const tbody = document.getElementById('rows');
      const tr = document.createElement('tr');

      // 額面 + ＋ボタン
      const tdA = document.createElement('td');
      const wrap = document.createElement('div');
      wrap.className = 'amount-wrap';

      const amount = document.createElement('input');
      amount.type = 'text';                 // iOSで + を入れやすく
      amount.setAttribute('inputmode','numeric');
      amount.placeholder = '20 または 20+100';
      amount.className = 'input--box amount';
      amount.value = amountText || '';

      const plus = document.createElement('button');
      plus.type = 'button';
      plus.className = 'plus-btn';
      plus.textContent = '+';
      plus.addEventListener('click', ()=>{
        const v = amount.value || '';
        amount.value = v.endsWith('+') ? v : (v + '+');
        amount.focus();
        recalc();
      });

      wrap.appendChild(amount);
      wrap.appendChild(plus);
      tdA.appendChild(wrap);

      // 枚数（シート内）
      const tdP = document.createElement('td');
      const per = document.createElement('input');
      per.type = 'number'; per.min = '0';
      per.placeholder = '（空欄なら…）';
      per.className = 'input--box per';
      per.value = perSheetText || '';
      tdP.appendChild(per);

      // シート数 or 枚数
      const tdS = document.createElement('td');
      const sheets = document.createElement('input');
      sheets.type = 'number'; sheets.min = '0';
      sheets.className = 'input--box sheets';
      sheets.value = sheetOrCount || '';
      tdS.appendChild(sheets);

      // 小計
      const tdSub = document.createElement('td');
      tdSub.className = 'right subtotal';
      tdSub.textContent = '0 円';

      // 削除
      const tdOps = document.createElement('td');
      const rm = document.createElement('button');
      rm.type='button'; rm.textContent='削除';
      rm.addEventListener('click', ()=>{ tr.remove(); recalc(); });
      tdOps.appendChild(rm);

      tr.appendChild(tdA);
      tr.appendChild(tdP);
      tr.appendChild(tdS);
      tr.appendChild(tdSub);
      tr.appendChild(tdOps);

      tbody.appendChild(tr);
      [amount, per, sheets].forEach(el=> el.addEventListener('input', recalc));
      return tr;
    }

    // ---- 額面文字列を数値へ（"5+25" → 30）
    function evalAmount(expr){
      if(!expr) return 0;
      expr = String(expr).replace(/^\+|\+$/g,'').replace(/\+\+/g,'+');
      if(!expr) return 0;
      const parts = expr.split('+').map(s=>Number(s.trim())).filter(n=>!Number.isNaN(n));
      return parts.reduce((a,b)=>a+b,0);
    }

    // ---- 明細のフォーマット
    function formatDetail(amountExpr, perSheet, sheetOrCount, lineTotal){
      const amt = amountExpr || '0';
      const showPer = perSheet > 0;
      const base = showPer
        ? (perSheet === 1 ? `${amt}` : `(${amt})×${perSheet}`)
        : `${amt}`;
      const expr = sheetOrCount ? `${base}×${sheetOrCount}` : base;
      return `${expr} = ${lineTotal.toLocaleString()}`;
    }

    // ---- 再計算
    function recalc(){
      let sum = 0;
      const lines = [];

      document.querySelectorAll('#rows tr').forEach(tr=>{
        const amountExpr = tr.querySelector('.amount')?.value.trim() ?? '';
        const per = Number(tr.querySelector('.per')?.value || 0);
        const sheets = Number(tr.querySelector('.sheets')?.value || 0);

        const face = evalAmount(amountExpr);
        const perApplied = per > 0 ? per : 0;
        let units = face;

        if(perApplied > 0) units = face * perApplied;

        const times = sheets > 0 ? sheets : (perApplied > 0 ? 1 : 0);
        const lineTotal = times ? units * times : units;

        const sub = tr.querySelector('.subtotal');
        if (sub) sub.textContent = `${lineTotal.toLocaleString()} 円`;

        if(face > 0){
          lines.push( formatDetail(amountExpr, perApplied, sheets>0 ? sheets : null, lineTotal) );
        }
        sum += lineTotal;
      });

      document.getElementById('detail').textContent =
        lines.length ? lines.join('　') : '（ここに計算式が表示されます）';
      document.getElementById('grand').textContent = sum.toLocaleString();

      saveRows();
    }

    // ---- 共有/コピー
    async function shareOrCopy(){
      const text = `【切手カウンター】\n${document.getElementById('detail').textContent}\n合計：${document.getElementById('grand').textContent}円`;
      try{
        if(navigator.share){
          await navigator.sha
