<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>切手カウンター（複合額面・空白スタート＋ボタン）</title>

<!-- PWA: すでに manifest / SW を使っている場合はそのまま -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#105FCA">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
  :root { --radius: 12px; }
  * { box-sizing: border-box; }

  body {
    font-family: -apple-system, system-ui, "Segoe UI", Roboto,
                 "Hiragino Kaku Gothic ProN","Noto Sans JP", Arial, sans-serif;
    margin: 14px;
  }

  h1 { font-size: 20px; margin: 0 0 8px; }
  .hint { color:#666; font-size: 12px; margin-bottom: 10px; }

  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom: 10px; }
  button { padding:10px 12px; border-radius: var(--radius); border:1px solid #ccc; font-size:16px; }
  .primary { background:#111; color:#fff; border-color:#111; }

  .sectionTitle { font-size: 13px; color:#666; margin: 8px 0; }
  .chipswrap { display:flex; gap:8px; overflow-x:auto; padding:4px 0; }
  .chip { border:1px solid #ccc; background:#fff; padding:7px 10px; border-radius:999px; white-space:nowrap; cursor:pointer; user-select:none; }
  .chip:active { background:#eee; }

  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #eee; vertical-align: middle; }
  th { font-weight:700; text-align:left; }

  input[type="number"], input[type="text"] {
    width: 90px; padding: 10px;
    border: 1px solid #ccc; border-radius: var(--radius); font-size: 16px;
  }

  .right { text-align:right; font-variant-numeric: tabular-nums; }

  .row-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
  .row-actions button { padding:8px 10px; }

  .totalbar { position:sticky; bottom:0; background:rgba(255,255,255,0.96); backdrop-filter: blur(8px); border-top:1px solid #eee; padding: 10px 12px; font-size:18px; font-weight:700; text-align:right; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); }

  .summary { margin-top:14px; padding:12px; border:1px solid #eee; border-radius: var(--radius); min-height: 140px; }

  /* ▼ 額面入力エリア（＋ボタン横並び） */
  .amount-wrap { display: inline-flex; align-items: center; gap: 8px; width: 100%; }
  .amount-wrap .amount { flex: 1 1 auto; min-width: 160px; }       /* ←額面を広めに */
  .plus-btn { width: 46px; height: 46px; border-radius: 50%; font-size: 22px; display:inline-flex; align-items:center; justify-content:center; }

  /* 行内の各入力サイズをそろえる */
  .cell-narrow { width: 110px; }
  .cell-narrow input { width: 100%; }

  /* スマホ向け微調整 */
  @media (max-width: 480px){
    input[type="number"], input[type="text"]{ font-size: 17px; }
    .amount-wrap .amount { min-width: 0; }
  }
</style>
</head>
<body>

<h1>切手カウンター（複合額面・空白スタート）</h1>
<p class="hint">
  額面は「20」だけでなく <b>20+100</b> のように＋で合算できます。枚数（シート内）が空白/0 の時は
  <b>額面×シート数or枚数</b> で計算。下に明細テキストを自動表示します。<br>
  右の <b>＋</b> ボタンでスマホでも簡単にプラスを入力できます。
</p>

<div class="toolbar">
  <button id="addRow">行を追加</button>
  <button id="clearAll">全てクリア</button>
  <button id="shareBtn" class="primary">結果を共有/コピー</button>
</div>

<div class="sectionTitle">よく使う額面</div>
<div class="chipswrap" id="chips"></div>

<table id="tbl">
  <thead>
    <tr>
      <th>額面（円, 例: 20 または 20+100）</th>
      <th class="cell-narrow">枚数（シート内）</th>
      <th class="cell-narrow">シート数 or 枚数</th>
      <th class="right">小計</th>
      <th class="right">行</th>
    </tr>
  </thead>
  <tbody id="tb"></tbody>
</table>

<div class="summary">
  <div style="font-weight:700; margin-bottom:6px;">明細</div>
  <pre id="detail" style="margin:0; font: inherit; white-space:pre-wrap;">（ここに計算式が表示されます）</pre>
</div>

<div class="totalbar" id="grand">合計 0 円</div>

<script>
/* ---------- ユーティリティ ---------- */
const fmt = n => n.toLocaleString('ja-JP');
const yen = n => fmt(n) + ' 円';
const parseAmount = (txt) => {
  if(!txt) return 0;
  return txt.split('+')
            .map(s => s.trim())
            .filter(s => s !== '')
            .map(Number)
            .filter(n => Number.isFinite(n))
            .reduce((a,b)=>a+b,0);
};

/* ---------- 行の描画/計算 ---------- */
const tbody = document.getElementById('tb');
const detail = document.getElementById('detail');
const grand = document.getElementById('grand');

function addRow(amountText='', per='', sheets=''){
  const tr = document.createElement('tr');

  // 額面 +（＋）ボタン
  const tdAmount = document.createElement('td');
  tdAmount.innerHTML = `
    <div class="amount-wrap">
      <input class="amount" type="text" placeholder="20 または 20+100" value="${amountText}">
      <button class="plus-btn" type="button" title="＋を入れる">＋</button>
    </div>`;
  tr.appendChild(tdAmount);

  // 枚数（シート内）
  const tdPer = document.createElement('td');
  tdPer.className = 'cell-narrow';
  tdPer.innerHTML = `<input type="number" inputmode="numeric" placeholder="(空欄なら…)" value="${per}">`;
  tr.appendChild(tdPer);

  // シート数 or 枚数
  const tdSheets = document.createElement('td');
  tdSheets.className = 'cell-narrow';
  tdSheets.innerHTML = `<input type="number" inputmode="numeric" placeholder="シート数 or 枚数" value="${sheets}">`;
  tr.appendChild(tdSheets);

  // 小計
  const tdSub = document.createElement('td');
  tdSub.className = 'right';
  tdSub.textContent = '0 円';
  tr.appendChild(tdSub);

  // 行操作
  const tdOp = document.createElement('td');
  tdOp.className = 'right row-actions';
  tdOp.innerHTML = `<button class="del">削除</button>`;
  tr.appendChild(tdOp);

  tbody.appendChild(tr);

  // イベント
  const amtInput = tr.querySelector('.amount');
  const plusBtn = tr.querySelector('.plus-btn');
  const perInput = tdPer.querySelector('input');
  const sheetsInput = tdSheets.querySelector('input');

  const recalcRow = () => {
    const amountSum = parseAmount(amtInput.value);
    const perVal = Number(perInput.value || 0);
    const sheetsVal = Number(sheetsInput.value || 0);

    let sub = 0;
    let line = '';

    if (perVal > 0) {
      // 枚数（シート内）が入っている
      if (sheetsVal > 0) {
        // シート数>0: (額面×枚数)×シート数
        sub = amountSum * perVal * sheetsVal;
        const left = `${amountSum}×${perVal}`;
        // シート数が1なら括弧を付けない
        line = (sheetsVal === 1)
          ? `${left} = ${fmt(sub)}`
          : `(${left}) ×${sheetsVal} = ${fmt(sub)}`;
      } else {
        // シート数空欄: 額面×枚数（「1シートだけ」のケース想定）
        sub = amountSum * perVal;
        line = `${amountSum}×${perVal} = ${fmt(sub)}`;
      }
    } else {
      // 枚数（シート内）が空欄/0 → 額面×（シート数 or 枚数）
      if (sheetsVal > 0) {
        sub = amountSum * sheetsVal;
        line = `${amountSum}×${sheetsVal} = ${fmt(sub)}`;
      } else {
        sub = 0;
        line = ''; // どちらも空欄なら表示なし
      }
    }

    tdSub.textContent = yen(sub);
    tr.dataset.detail = line;
    recalcAll();
  };

  // ＋ボタン：末尾に「+」を挿入（カーソルは末尾）
  plusBtn.addEventListener('click', () => {
    amtInput.value = (amtInput.value || '').replace(/\s+$/,'') + (amtInput.value ? '+' : '');
    amtInput.focus();
    amtInput.setSelectionRange(amtInput.value.length, amtInput.value.length);
    recalcRow();
  });

  amtInput.addEventListener('input', recalcRow);
  perInput.addEventListener('input', recalcRow);
  sheetsInput.addEventListener('input', recalcRow);

  tr.querySelector('.del').addEventListener('click', () => {
    tr.remove();
    recalcAll();
  });

  recalcRow();
}

function recalcAll(){
  let sum = 0;
  const lines = [];
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const txt = tr.dataset.detail || '';
    const sub = tr.querySelector('td.right').textContent.replace(/[^\d]/g,'');
    if (txt) lines.push(txt);
    sum += Number(sub||0);
  });

  detail.textContent = lines.length ? (lines.join('\n') + `\n\n合計 ${fmt(sum)}`) : '（ここに計算式が表示されます）';
  grand.textContent = '合計 ' + yen(sum);
}

/* ---------- よく使う額面（チップ） ---------- */
const chipValues = [1,2,5,10,20,30,50,63,70,84,94,100,120,140,160,180,200,210,260,320,500,1000];
const chips = document.getElementById('chips');
chips.innerHTML = chipValues.map(v=>`<div class="chip" data-amt="${v}">${v}円</div>`).join('');
chips.addEventListener('click', (e)=>{
  const c = e.target.closest('.chip'); if(!c) return;
  const tr = tbody.querySelector('tr:last-child') || addRow();
  const amt = tr?.querySelector('.amount');
  if(amt){
    const add = String(c.dataset.amt || '');
    amt.value = amt.value ? (amt.value + '+' + add) : add;
    amt.dispatchEvent(new Event('input'));
  }
});

/* ---------- ボタン類 ---------- */
document.getElementById('addRow').addEventListener('click', ()=> addRow('','',''));
document.getElementById('clearAll').addEventListener('click', ()=>{
  tbody.innerHTML = '';
  addRow('','','');
  recalcAll();
});
document.getElementById('shareBtn').addEventListener('click', async ()=>{
  const text = detail.textContent.replace(/\n{2,}/g,'\n');
  try{
    if(navigator.share){
      await navigator.share({ text });
    }else{
      await navigator.clipboard.writeText(text);
      alert('コピーしました');
    }
  }catch(e){}
});

/* 初期行 */
addRow('','','');

/* ---------- Service Worker 登録（ある場合） ---------- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
}
</script>
</body>
</html>
