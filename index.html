<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>切手カウンター（複合額面・空白スタート）</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#105FCA" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<style>
  :root { --radius:12px; }
  * { box-sizing:border-box; }

  body{
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Arial,sans-serif;
    margin:14px;
  }
  h1{ font-size:20px; margin:0 0 8px; }
  .hint{ color:#666; font-size:12px; margin:6px 0 12px; }

  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
  button{ padding:10px 12px; border-radius:var(--radius); border:1px solid #ccc; background:#fff; cursor:pointer; }
  .primary{ background:#111; color:#fff; border-color:#111; }

  .sectionTitle{ font-size:13px; color:#666; margin:10px 0 6px; }
  .chipsbar{ display:flex; gap:8px; align-items:center; }
  .chipswrap{ display:flex; gap:8px; overflow-x:auto; padding:4px 0; }
  .chip{ border:1px solid #ccc; background:#fff; padding:7px 10px; border-radius:9999px; white-space:nowrap; cursor:pointer; user-select:none; }
  .chip:active{ background:#eee; }

  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; border-bottom:1px solid #eee; vertical-align:middle; }
  th{ text-align:left; font-weight:700; }
  .right{ text-align:right; font-variant-numeric:tabular-nums; }

  /* 見出し：1列目だけ折返し可、他は1行 */
  thead th{ white-space:nowrap; }
  thead th:first-child{ white-space:normal; }
  .header-multiline span{ display:block; line-height:1.2; }

  /* 入力3つは同じ幅（小さめ） */
  .field{ width:112px; }
  .amount-wrap{ display:inline-flex; align-items:center; gap:6px; }
  .amount{ width:112px; }

  input[type="number"], input[type="text"]{
    width:100%; padding:10px 11px; border:1px solid #ccc; border-radius:var(--radius);
    font-size:17px; background:#fff; height:42px;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  input[type="number"]{ -moz-appearance:textfield; }

  .plus-btn{
    width:36px; height:36px; border-radius:12px; font-size:20px; line-height:1;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; background:#fff; cursor:pointer;
  }

  /* 明細：縦に1項目ずつ */
  .summary{ margin-top:14px; padding:12px; border:1px solid #eee; border-radius:var(--radius); background:#fafafa; }
  #detail{ white-space:pre-wrap; line-height:1.45; font-variant-numeric:tabular-nums; }

  .totalbar{ position:sticky; bottom:0; background:rgba(255,255,255,.96); backdrop-filter:blur(6px);
    padding:12px; border:1px solid #eee; border-radius:var(--radius); margin-top:12px; }

  /* ===== コンパクト表示（1画面に収める用） ===== */
  body.compact h1{ font-size:18px; }
  body.compact .hint{ font-size:11px; margin:4px 0 8px; }
  body.compact button{ padding:8px 10px; }
  body.compact input[type="number"], body.compact input[type="text"]{ height:36px; font-size:16px; padding:8px 9px; }
  body.compact .field, body.compact .amount{ width:102px; }
  body.compact .plus-btn{ width:32px; height:32px; font-size:18px; }
  body.compact th, body.compact td{ padding:6px; }
  body.compact #detail{ line-height:1.35; font-size:14px; }
</style>
</head>
<body>
  <h1>切手カウンター（複合額面・空白スタート）</h1>
  <div class="hint">
    額面は「20」だけでなく <b>20+100</b> のように＋で合算できます。<br>
    枚数（シート内）が空白/0 の時は <b>額面×シート数or枚数</b> で計算。下に明細を自動表示します。
  </div>

  <div class="toolbar">
    <button id="addRow">行を追加</button>
    <button id="clearAll">全てクリア</button>
    <button id="shareBtn" class="primary">結果を共有/コピー</button>
    <button id="toggleCompact">コンパクト表示</button>
  </div>

  <div class="sectionTitle">よく使う額面</div>
  <div class="chipsbar">
    <div class="chipswrap" id="chips"></div>
    <button id="editPresets">編集</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>額面（円, 例: 20 または 20+100）</th>
        <th>枚数（シート内）</th>
        <th><span class="header-multiline"><span>シート数</span><span>or</span><span>枚数</span></span></th>
        <th class="right">小計</th>
        <th>行</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="summary">
    <div class="sectionTitle">明細</div>
    <pre id="detail">（ここに計算式が表示されます）</pre>
  </div>
  <div class="totalbar right">合計 <span id="grand">0</span> 円</div>

<script>
  /* ========= プリセット（編集可 / 端末保存） ========= */
  const LS_PRESETS = 'stamp_presets_v1';
  const DEFAULT_PRESETS = [1,2,5,10,20,30,50,63,70,84,94,100,120,140,160,180,200,210,260,320,500,1000];

  const getPresets = () => {
    try{ const a = JSON.parse(localStorage.getItem(LS_PRESETS)||'[]'); return Array.isArray(a)&&a.length ? a : DEFAULT_PRESETS; }
    catch(_){ return DEFAULT_PRESETS; }
  };
  const setPresets = (arr) => localStorage.setItem(LS_PRESETS, JSON.stringify(arr));

  const chips = document.getElementById('chips');
  function renderChips(){
    chips.innerHTML = getPresets().map(v=>`<button class="chip" data-amt="${v}">${v}円</button>`).join('');
  }
  document.getElementById('editPresets').addEventListener('click', ()=>{
    const cur = getPresets().join(',');
    const s = prompt('よく使う額面（カンマ区切り・例: 1,2,5,10,20,30,50）', cur);
    if(s===null) return;
    const arr = s.split(',').map(x=>Number(String(x).trim())).filter(n=>Number.isFinite(n)&&n>0);
    if(arr.length){ setPresets(arr); renderChips(); }
    else alert('数値をカンマ区切りで入力してください');
  });

  chips.addEventListener('click', e=>{
    const b = e.target.closest('.chip'); if(!b) return;
    addRow(String(b.dataset.amt||''), '', ''); // 新しい行に額面をセット
  });

  /* ========= 行生成 ========= */
  const tbody = document.getElementById('rows');

  function addRow(amountText='', perSheetText='', sheetOrCount=''){
    const tr = document.createElement('tr');

    // 額面＋ボタン
    const tdA = document.createElement('td');
    const wrap = document.createElement('div'); wrap.className='amount-wrap';
    const amount = document.createElement('input');
    amount.type='text'; amount.inputMode='numeric'; amount.placeholder='20 または 20+100';
    amount.className='amount field'; amount.value=amountText;

    const plus = document.createElement('button');
    plus.type='button'; plus.className='plus-btn'; plus.textContent='＋';
    plus.addEventListener('click', ()=>{
      const v = amount.value.trim();
      amount.value = v===''? '+' : (v.endsWith('+')? v : v + '+');
      amount.focus(); const len=amount.value.length; amount.setSelectionRange(len,len);
      recalc();
    });
    wrap.append(amount, plus); tdA.appendChild(wrap);

    // 枚数（シート内）
    const tdP = document.createElement('td');
    const per = document.createElement('input');
    per.type='number'; per.min='0'; per.placeholder='（空欄なら…）';
    per.className='per field'; per.value=perSheetText; tdP.appendChild(per);

    // シート数 or 枚数
    const tdS = document.createElement('td');
    const sheets = document.createElement('input');
    sheets.type='number'; sheets.min='0'; sheets.placeholder='シート数 / 枚数';
    sheets.className='sheets field'; sheets.value=sheetOrCount; tdS.appendChild(sheets);

    // 小計
    const tdSub = document.createElement('td'); tdSub.className='right subtotal'; tdSub.textContent='0 円';

    // 削除
    const tdOps = document.createElement('td');
    const rm = document.createElement('button'); rm.type='button'; rm.textContent='削除';
    rm.addEventListener('click', ()=>{ tr.remove(); recalc(); });
    tdOps.appendChild(rm);

    tr.append(tdA, tdP, tdS, tdSub, tdOps);
    tbody.appendChild(tr);

    [amount, per, sheets].forEach(el=> el.addEventListener('input', recalc));
    recalc();
  }

  /* ========= 計算 ========= */
  const yen = n => (isFinite(n)? n:0).toLocaleString('ja-JP');

  function sumAmount(text){
    return String(text||'').split('+').map(s=>Number(String(s).trim()))
      .filter(n=>Number.isFinite(n)).reduce((a,b)=>a+b,0);
  }
  function displayAmountExpr(raw){
    const parts = String(raw||'').split('+').map(s=>s.trim()).filter(Boolean);
    return parts.length>=2 ? `(${parts.join('+')})` : (parts[0]||'');
  }

  function calcRow(tr){
    const amtRaw = tr.querySelector('.amount').value;
    const per    = Number(tr.querySelector('.per').value||0);
    const sheet  = Number(tr.querySelector('.sheets').value||0);

    const A = sumAmount(amtRaw);
    const expr = displayAmountExpr(amtRaw) || (A? String(A):'');

    let subtotal = 0, lineText = '';

    if(!A){ subtotal=0; }
    else if(!per && sheet>0){
      subtotal = A * sheet;
      lineText = `${expr||A}×${sheet} = ${yen(subtotal)}`;
    }else if(per>0){
      const inner = A * per;
      if(sheet>0){
        subtotal = inner * sheet;
        const left = `${expr||A}×${per}`;
        lineText = (sheet===1) ? `${left} = ${yen(subtotal)}` : `(${left}) ×${sheet} = ${yen(subtotal)}`;
      }else{
        subtotal = inner;
        lineText = `${expr||A}×${per} = ${yen(subtotal)}`;
      }
    }

    tr.querySelector('.subtotal').textContent = `${yen(subtotal)} 円`;
    return { subtotal, lineText };
  }

  function recalc(){
    let total=0; const lines=[];
    tbody.querySelectorAll('tr').forEach(tr=>{
      const r = calcRow(tr);
      if(r.lineText) lines.push(r.lineText);
      total += r.subtotal;
    });
    document.getElementById('detail').textContent = lines.length ? lines.join('\n') : '（ここに計算式が表示されます）';
    document.getElementById('grand').textContent  = yen(total);
  }

  /* ========= ツールバー ========= */
  document.getElementById('addRow').addEventListener('click', ()=> addRow('','',''));
  document.getElementById('clearAll').addEventListener('click', ()=>{
    tbody.innerHTML=''; addRow('','',''); recalc();
  });
  document.getElementById('shareBtn').addEventListener('click', async ()=>{
    const text = `明細\n${document.getElementById('detail').textContent}\n\n合計 ${document.getElementById('grand').textContent} 円`;
    t
