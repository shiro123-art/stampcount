<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>切手カウンター（複合額面・空白スタート）</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#105FCA" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<style>
  :root{
    --radius:12px;
    /* ←必要なら数字だけ変えてOK */
    --w-amount:64px;     /* 額面（さらに小さめに固定） */
    --w-count:140px;     /* 枚数／シート数（広め・同じ幅） */
    --btn-size:34px;     /* ＋ボタン（押しやすい最小サイズ） */
  }
  *{ box-sizing:border-box; }
  body{
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Arial,sans-serif;
    margin:14px;
  }
  h1{ font-size:20px; margin:0 0 8px; }
  .hint{ color:#666; font-size:12px; margin:6px 0 12px; }

  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0; }
  button{ padding:10px 12px; border:1px solid #ccc; border-radius:var(--radius); background:#fff; cursor:pointer; }
  .primary{ background:#111; color:#fff; border-color:#111; }

  /* よく使う額面：横スクロール無しで複数行ラップ */
  .chips-ops{ display:flex; gap:8px; align-items:center; margin:6px 0; }
  .chipswrap{
    display:flex; flex-wrap:wrap;
    gap:6px 8px; padding:6px 0 2px; overflow:visible;
  }
  .chip{
    border:1px solid #ccc; background:#fff;
    padding:6px 9px; border-radius:9999px; white-space:nowrap;
    user-select:none; cursor:pointer; font-size:14px; line-height:1;
  }
  .chip:active{ background:#eee; }

  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:8px; border-bottom:1px solid #eee; vertical-align:middle; }
  th{ text-align:left; font-weight:700; }
  .right{ text-align:right; font-variant-numeric:tabular-nums; }

  /* 見出しの縦並び */
  .th-multi{ line-height:1.25; }
  .th-multi .br{ display:block; }

  /* 入力UI */
  input[type="text"], input[type="number"]{
    width:100%; padding:10px 11px; border:1px solid #ccc; border-radius:var(--radius);
    font-size:17px; background:#fff;
  }

  /* 額面＋ボタンを2列のGridにして常時表示に */
  .amount-wrap{
    display:grid;
    grid-template-columns: var(--w-amount) var(--btn-size);
    align-items:center;
    gap:6px;
    width:max-content;   /* 中身ぶんだけ。はみ出しても縮まない */
  }
  .amount{ width:var(--w-amount); }
  .per   { width:var(--w-count);  }
  .sheet { width:var(--w-count);  }

  .plus-btn{
    width:var(--btn-size); height:var(--btn-size);
    border-radius:12px; font-size:20px; line-height:1;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; background:#fff; cursor:pointer;
    flex:0 0 auto;
  }

  .summary{ margin-top:14px; padding:12px; border:1px solid #eee; border-radius:var(--radius); background:#fafafa; }
  .summary h2{ font-size:14px; margin:0 0 8px; }
  #detail{ white-space:pre-line; }  /* 明細を縦並びで表示 */

  .totalbar{
    position:sticky; bottom:0; background:rgba(255,255,255,.96); backdrop-filter:blur(6px);
    padding:12px; border:1px solid #eee; border-radius:var(--radius); margin-top:12px;
  }
  .totalbar .right{ font-size:18px; }
</style>
</head>
<body>
  <h1>切手カウンター（複合額面・空白スタート）</h1>
  <div class="hint">
    額面は「20」だけでなく <b>20+100</b> のように＋で合算できます。<br>
    枚数（シート内）が空白/0 の時は <b>額面×シート数or枚数</b> で計算。下に明細テキストを自動表示します。
  </div>

  <div class="toolbar">
    <button id="addRow">行を追加</button>
    <button id="clearAll">全てクリア</button>
    <button id="shareBtn" class="primary">結果を共有/コピー</button>
  </div>

  <div class="chips-ops">
    <div class="sectionTitle">よく使う額面</div>
    <button id="editPresets">編集</button>
  </div>
  <div class="chipswrap" id="chips"></div>

  <table>
    <thead>
      <tr>
        <th>額面（円, 例: 20 または 20+100）</th>
        <th class="th-multi">枚数<span class="br">（シート内）</span></th>
        <th class="th-multi">シート数<span class="br">or</span><span class="br">枚数</span></th>
        <th class="right">小計</th>
        <th>行</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="summary">
    <h2>明細</h2>
    <div id="detail">（ここに計算式が表示されます）</div>
  </div>

  <div class="totalbar">
    <div class="right">合計 <span id="grand">0</span> 円</div>
  </div>

<script>
  /* ====== 定数・保存キー ====== */
  const LS_PRESETS = 'stamp_presets_v1';
  const tbody  = document.getElementById('tbody');
  const detail = document.getElementById('detail');
  const grand  = document.getElementById('grand');

  const yen = n => (isFinite(n)? n:0).toLocaleString('ja-JP');

  /* ====== 額面の合算（"20+100" → 120） ====== */
  function sumAmount(text){
    return String(text||'').split('+')
      .map(s=>Number(String(s).trim()))
      .filter(n=>Number.isFinite(n))
      .reduce((a,b)=>a+b,0);
  }
  /* 表示用：+を含むときは (20+100) と括弧表示 */
  function displayAmountExpr(raw){
    const t = String(raw||'').split('+').map(s=>s.trim()).filter(Boolean);
    return (t.length>=2)?`(${t.join('+')})`:(t[0]??'');
  }

  /* ====== 行UI ====== */
  function addRow(amountText='', perSheet='', sheets=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="amount-wrap">
          <input class="amount" type="text" inputmode="numeric" placeholder="20 または 20+100" value="${amountText}">
          <button class="plus-btn" type="button" title="+">＋</button>
        </div>
      </td>
      <td><input class="per"   type="number" min="0" placeholder="（空欄なら…）" value="${perSheet}"></td>
      <td><input class="sheet" type="number" min="0" placeholder="シート数 or 枚数" value="${sheets}"></td>
      <td class="right"><span class="sub">0</span> 円</td>
      <td class="right"><button class="del">削除</button></td>
    `;
    tbody.appendChild(tr);
    bindRow(tr);
    recalc();
  }
  function bindRow(tr){
    const amt   = tr.querySelector('.amount');
    const per   = tr.querySelector('.per');
    const sheet = tr.querySelector('.sheet');
    const del   = tr.querySelector('.del');
    const plus  = tr.querySelector('.plus-btn');

    [amt,per,sheet].forEach(el=> el.addEventListener('input', recalc));
    del.addEventListener('click', ()=>{ tr.remove(); recalc(); });
    plus.addEventListener('click', ()=>{
      const v = amt.value.trim();
      amt.value = v==='' ? '+' : (v.endsWith('+')? v : v + '+');  // 末尾に+を追加
      amt.focus(); const len = amt.value.length; amt.setSelectionRange(len,len);
      recalc();
    });
  }

  /* ====== 行計算 ====== */
  function calcRow(tr){
    const raw   = tr.querySelector('.amount').value;
    const per   = Number(tr.querySelector('.per').value||0);
    const sheet = Number(tr.querySelector('.sheet').value||0);

    const A = sumAmount(raw);
    const expr = displayAmountExpr(raw) || (A?String(A):'');

    let subtotal = 0, lineText = '';

    if (!A || (!per && !sheet)) {
      subtotal = 0; lineText = '';
    } else if (!per) {
      /* シート内が空 → 額面×シート数or枚数 */
      subtotal = A * sheet;
      if (sheet>0) lineText = `${expr||A}×${sheet} = ${yen(subtotal)}`;
    } else {
      /* 枚数あり → (額面×枚数)×シート数（シート=1は括弧省略） */
      const inner = A * per;
      if (sheet>0){
        subtotal = inner * sheet;
        const left = `${expr||A}×${per}`;
        lineText = (sheet===1)? `${left} = ${yen(subtotal)}` : `(${left}) ×${sheet} = ${yen(subtotal)}`;
      }else{
        subtotal = inner;
        lineText = `${expr||A}×${per} = ${yen(subtotal)}`;
      }
    }

    tr.querySelector('.sub').textContent = yen(subtotal);
    return { subtotal, lineText };
  }

  function recalc(){
    let total = 0; const lines = [];
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      const r = calcRow(tr);
      if(r.lineText) lines.push(r.lineText);
      total += r.subtotal;
    });
    detail.textContent = lines.length ? lines.join('\n') : '（ここに計算式が表示されます）';
    grand.textContent  = yen(total);
  }

  /* ====== よく使う額面（編集可） ====== */
  function getPresets(){
    try{
      const s = localStorage.getItem(LS_PRESETS);
      if(!s) return [1,2,5,10,20,30,50,63,70,84,94,100,120,140,160,180,200,210,260,320,500,1000];
      const a = JSON.parse(s);
      return Array.isArray(a) && a.length ? a : [1,2,5,10,20,30,50];
    }catch(_){ return [1,2,5,10,20,30,50]; }
  }
  function setPresets(a){
    localStorage.setItem(LS_PRESETS, JSON.stringify(a));
  }
  function renderChips(){
    const wrap = document.getElementById('chips');
    wrap.innerHTML = getPresets().map(v=>`<div class="chip" data-amt="${v}">${v}円</div>`).join('');
  }
  document.getElementById('chips').addEventListener('click', e=>{
    const c = e.target.closest('.chip'); if(!c) return;
    addRow(String(c.dataset.amt||''),'','');   // 新しい行に追加
  });
  document.getElementById('editPresets').addEventListener('click', ()=>{
    const cur = getPresets().join(',');
    const s = prompt('よく使う額面（カンマ区切り）', cur);
    if(s===null) return;
    const arr = s.split(',').map(x=>Number(String(x).trim())).filter(n=>Number.isFinite(n) && n>0);
    if(arr.length){ setPresets(arr); renderChips(); }
  });

  /* ====== ツールバー ====== */
  document.getElementById('addRow').addEventListener('click', ()=> addRow('','',''));
  document.getElementById('clearAll').addEventListener('click', ()=>{
    tbody.innerHTML=''; addRow('','',''); recalc();
  });
  document.getElementById('shareBtn').addEventListener('click', async ()=>{
    const text = `明細\n${detail.textContent}\n\n合計 ${grand.textContent} 円`;
    try{
      if(navigator.share){ await navigator.share({ text }); }
      else{ await navigator.clipboard.writeText(text); alert('コピーしました'); }
    }catch(_){}
  });

  /* ====== 初期化 ====== */
  (function init(){
    renderChips();
    addRow('','','');
    recalc();
  })();

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
</script>
</body>
</html>
